name: PR Depot Process Optimized

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write    # Repo push iÅŸlemi iÃ§in
  pull-requests: write # PR kapatma ve yorum iÃ§in

jobs:
  process:
    name: Process Steam Depot
    runs-on: windows-latest

    steps:
      # --- 1) Repo'yu checkout et ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- 2) PR DosyalarÄ±nÄ± Ä°ndir (TÃ¼m deÄŸiÅŸenler - Yeni MantÄ±k) ---
      - name: Fetch PR Files (All)
        if: github.event_name == 'pull_request'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "ğŸ“¥ PR #$env:PR_NUMBER dosyalarÄ± taranÄ±yor ve indiriliyor..."

          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github.v3+json"
          }

          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$env:PR_NUMBER/files"
          $files = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $files) {
            Write-Warning "âš ï¸ PR iÃ§inde dosya bulunamadÄ± veya API yanÄ±t vermedi."
            exit 0
          }

          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          $downloadCount = 0

          foreach ($file in $files) {
            # Sadece silinen (removed) dosyalarÄ± atla, Geri kalan tÃ¼m dosyalarÄ± indir
            if ($file.status -eq "removed") { continue }
            
            # OlasÄ± alt klasÃ¶rleri de oluÅŸtur (filename tam path'i iÃ§erir)
            $fullPath = Join-Path $tempDir $file.filename
            $dir = Split-Path -Parent $fullPath
            if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }

            # DosyayÄ± indir
            Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath
            Write-Host "â¬‡ï¸ Ä°ndirildi: $($file.filename)"
            $downloadCount++
          }

          if ($downloadCount -eq 0) {
            Write-Warning "âš ï¸ Ä°ndirilecek dosya bulunamadÄ±."
            exit 0
          }

          Write-Host "--- process_tmp KlasÃ¶r Ä°Ã§eriÄŸi (Debug) ---"
          Get-ChildItem -Path $tempDir -Recurse | Select-Object FullName
          Write-Host "-------------------------------------------"

      # --- 3) Depot Tools Ä°ndir ---
      - name: Download Depot Tools
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe")

          if (-not (Test-Path (Join-Path $toolDir "Depot.exe"))) {
            throw "âŒ Depot.exe indirilemedi!"
          }

      # --- 4) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      - name: Run Depot Dumper
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }} # GitHub Secrets'tan al
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }} # GitHub Secrets'tan al
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Ã‡alÄ±ÅŸma alanlarÄ±nÄ± ayarla
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) {
            Write-Host "â„¹ï¸ Ä°ÅŸlenecek dosya klasÃ¶rÃ¼ yok, iÅŸlem atlanÄ±yor."
            exit 0
          }

          # PKG dosyalarÄ±nÄ± bul (Sadece _pkgs.txt ile ilgileniyoruz)
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
            Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
            
            # Hata ayÄ±klama iÃ§in dizin iÃ§eriÄŸini tekrar gÃ¶ster
            Write-Host "--- HATA AYIKLAMA: process_tmp Ä°Ã§eriÄŸi ---"
            Get-ChildItem -Path $inputDir -Recurse | Select-Object FullName
            Write-Host "-------------------------------------------"
            exit 0 # BaÅŸarÄ±lÄ± Ã§Ä±kÄ±ÅŸ kodu
          }

          Write-Host "âœ”ï¸ $_pkgs.txt dosyalarÄ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
            $pkgPath = $pkg.FullName
            # PKG dosyasÄ±nÄ±n bulunduÄŸu dizini kullan
            $pkgDirectory = Split-Path -Parent $pkgPath
            
            $prefix = $pkg.BaseName -replace '_pkgs$', ''
            $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

            # Not: _keys.txt dosyasÄ±nÄ±n indirilmesini garanti altÄ±na almak iÃ§in 2. adÄ±mda filtrelemeyi kaldÄ±rdÄ±k.
            if (-not (Test-Path $keyFile)) {
              Write-Warning "âš ï¸ $($pkg.Name) iÃ§in eÅŸleÅŸen _keys dosyasÄ± bulunamadÄ±, atlanÄ±yor. (Bu dosyanÄ±n PR'da olduÄŸundan emin olun.)"
              continue
            }

            Write-Host "ğŸš€ Ä°ÅŸleniyor: $($pkg.Name)"

            # Dosya iÃ§eriÄŸini oku ve parse et
            $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' } # BOM temizle
            $firstLine = $content.Trim().Split("`n")[0]
            
            $parts = $firstLine -split ';'
            if ($parts.Count -lt 2) {
              Write-Error "âŒ Format hatasÄ±: $($pkg.Name) (app;token formatÄ±nda olmalÄ±)"
              continue
            }

            $appId = $parts[0].Trim()
            $token = $parts[1].Trim()

            Write-Host "    AppID: $appId"
            
            # DepotDumper Ã§alÄ±ÅŸtÄ±r (Ã‡Ä±ktÄ±yÄ± 'collected' klasÃ¶rÃ¼ne yÃ¶nlendir)
            Push-Location $outputDir
            try {
              # keys dosyasÄ±nÄ±n tam yolunu kullan
              & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
            }
            catch {
              Write-Error "âŒ Depot hatasÄ±: $_"
              throw $_
            }
            finally {
              Pop-Location
            }
          }

      # --- 5) SonuÃ§larÄ± Commit ve Push Et ---
      - name: Commit and Push Results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Sadece collected klasÃ¶rÃ¼nÃ¼ ekle
          git add collected/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ DeÄŸiÅŸiklik yok, push yapÄ±lmayacak."
          else
            echo "ğŸ“¦ Dosyalar commitleniyor..."
            git commit -m "Auto-process: Added depot files from PR #${{ github.event.pull_request.number || github.sha }}"
            git push
          fi

      # --- 6) PR'Ä± Kapat ---
      - name: Close Pull Request
        if: success() && github.event_name == 'pull_request'
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: |
            âœ… **Ä°ÅŸlem BaÅŸarÄ±lÄ±!**
            
            Depot dosyalarÄ± iÅŸlendi ve `collected` klasÃ¶rÃ¼ne eklendi.
            TeÅŸekkÃ¼rler! ğŸ¤–
          delete-branch: true # Opsiyonel: Ä°ÅŸlem bitince PR branch'ini siler
