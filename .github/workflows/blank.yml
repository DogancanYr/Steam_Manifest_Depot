name: PR Depot Process Optimized

# PR aÃ§Ä±ldÄ±ÄŸÄ±nda, gÃ¼ncellendiÄŸinde veya manuel olarak tetiklendiÄŸinde Ã§alÄ±ÅŸÄ±r
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Ä°ÅŸlem iÃ§in gerekli izinler
permissions:
  contents: write    # Repository'ye commit/push yapabilmek iÃ§in
  pull-requests: write # PR'Ä± kapatabilmek ve yorum ekleyebilmek iÃ§in

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest
    # EÄŸer bu bir PR ise, sadece kaynak (head) branch'de Ã§alÄ±ÅŸ
    # if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      # --- 1) Repo'yu checkout et ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Bu token ile sonraki adÄ±mlarda commit ve push yapÄ±labilir
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # TÃ¼m geÃ§miÅŸi getir (Gerekebilir)

      # --- 2) PR DosyalarÄ±nÄ± Ä°ndir (Sadece PR ile tetiklenirse) ---
      - name: Fetch PR Files (Changes Only)
        if: github.event_name == 'pull_request'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "ğŸ“¥ PR #$env:PR_NUMBER dosyalarÄ± taranÄ±yor ve indiriliyor..."
          
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github.v3+json"
          }

          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$env:PR_NUMBER/files?per_page=100"
          $files = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $files) {
            Write-Warning "âš ï¸ PR iÃ§inde dosya bulunamadÄ± veya API yanÄ±t vermedi. Ä°ÅŸlem atlanÄ±yor."
            exit 0
          }

          # Ä°ndirilen dosyalarÄ±n kopyalanacaÄŸÄ± geÃ§ici dizin
          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          $downloadCount = 0

          foreach ($file in $files) {
            # Sadece silinen (removed) dosyalarÄ± atla
            if ($file.status -eq "removed") { continue }
            
            # OlasÄ± alt klasÃ¶rleri de oluÅŸtur ve dosyayÄ± indir
            $fullPath = Join-Path $tempDir $file.filename
            $dir = Split-Path -Parent $fullPath
            if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }

            # DosyayÄ± indir
            try {
              Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
              Write-Host "â¬‡ï¸ Ä°ndirildi: $($file.filename)"
              $downloadCount++
            }
            catch {
              Write-Error "âŒ Ä°ndirme hatasÄ±: $($file.filename) - $_"
            }
          }

          if ($downloadCount -eq 0) {
            Write-Warning "âš ï¸ Ä°ÅŸlenecek dosya bulunamadÄ± (removed dÄ±ÅŸÄ±ndaki dosyalar)."
            exit 0
          }

          Write-Host "âœ… Toplam $downloadCount dosya baÅŸarÄ±yla indirildi."
          Write-Host "--- process_tmp KlasÃ¶r Ä°Ã§eriÄŸi ---"
          Get-ChildItem -Path $tempDir -Recurse | Select-Object FullName
          Write-Host "----------------------------------"

      # --- 3) Depot Tools Ä°ndir ---
      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop

          Write-Host "âœ… Depot.exe indirildi."

      # --- 4) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }} 
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) {
            Write-Host "â„¹ï¸ Ä°ÅŸlenecek dosya klasÃ¶rÃ¼ (process_tmp) yok, iÅŸlem atlanÄ±yor."
            exit 0
          }

          # *_pkgs.txt dosyalarÄ±nÄ± bul
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
            Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
            exit 0
          }

          Write-Host "âœ”ï¸ $_pkgs.txt dosyalarÄ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
            $pkgPath = $pkg.FullName
            $pkgDirectory = Split-Path -Parent $pkgPath
            
            $prefix = $pkg.BaseName -replace '_pkgs$', ''
            $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

            # *** KullanÄ±cÄ±nÄ±n istediÄŸi GÃœVENÄ°LÄ°R KONTROL ***
            if (-not (Test-Path $keyFile)) {
              Write-Warning "âš ï¸ $($pkg.Name) iÃ§in eÅŸleÅŸen anahtar dosyasÄ± ($("${prefix}_keys.txt")) bulunamadÄ±. Ä°ÅŸlem atlanÄ±yor."
              continue # Sonraki dosyaya geÃ§, hata verme
            }

            Write-Host "ğŸš€ Ä°ÅŸleniyor: $($pkg.Name)"

            # Dosya iÃ§eriÄŸini oku ve parse et (BOM temizliÄŸi dahil)
            $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' } 
            $firstLine = $content.Trim().Split("`n")[0]
            
            # app;token formatÄ±nÄ± kontrol et
            $parts = $firstLine -split ';'
            if ($parts.Count -lt 2) {
              Write-Error "âŒ Format hatasÄ±: $($pkg.Name). (app;token formatÄ±nda olmalÄ±)"
              continue
            }

            $appId = $parts[0].Trim()
            $token = $parts[1].Trim()

            Write-Host "Â  Â  AppID: $appId"
            
            # DepotDumper Ã§alÄ±ÅŸtÄ±r (Ã‡Ä±ktÄ±yÄ± 'collected' klasÃ¶rÃ¼ne yÃ¶nlendir)
            Push-Location $outputDir
            try {
              # -depotkeys parametresine tam yolu ver
              & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
              Write-Host "âœ… $($pkg.Name) iÅŸlemi tamamlandÄ±."
            }
            catch {
              Write-Error "âŒ Depot Dumper hatasÄ±: $_. Bu dosya iÃ§in iÅŸlem baÅŸarÄ±sÄ±z oldu."
              # Hata durumunda bile diÄŸer dosyalarla devam etmek iÃ§in "throw $_" komutunu kaldÄ±rdÄ±k.
            }
            finally {
              Pop-Location
            }
          }
          
          # Hata ayÄ±klama iÃ§in son klasÃ¶r iÃ§eriÄŸini gÃ¶ster
          Write-Host "--- collected KlasÃ¶r Ä°Ã§eriÄŸi ---"
          Get-ChildItem -Path $outputDir -Recurse | Select-Object FullName
          Write-Host "--------------------------------"

# --- 5) SonuÃ§larÄ± Commit ve Push Et ---
      - name: Commit and Push Results
        shell: bash # Sadece bu adÄ±m iÃ§in kabuÄŸu Bash olarak ayarla
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Sadece 'collected' klasÃ¶rÃ¼ndeki deÄŸiÅŸiklikleri takip et
          git add collected/
          
          # Commit edilecek bir deÄŸiÅŸiklik var mÄ± kontrol et
          # Bash sÃ¶zdizimi: 'git diff' 0 dÃ¶nerse deÄŸiÅŸiklik yok demektir.
          if git diff --cached --quiet; then
            echo "â„¹ï¸ collected/ klasÃ¶rÃ¼nde yeni deÄŸiÅŸiklik yok, push yapÄ±lmayacak."
          else
            echo "ğŸ“¦ Yeni Depot dosyalarÄ± commitleniyor..."
            git commit -m "Auto-process: Added depot files from PR #${{ github.event.pull_request.number || github.sha }}"
            
            # GeÃ§erli branch'e push et
            git push origin HEAD:${{ github.head_ref || github.ref_name }}

      # --- 6) PR'Ä± Kapat ve Yorum Ekle ---
      - name: Close Pull Request
        if: success() && github.event_name == 'pull_request'
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: |
            âœ… **Ä°ÅŸlem TamamlandÄ±!**
            
            TÃ¼m `_pkgs.txt` dosyalarÄ± baÅŸarÄ±yla iÅŸlendi ve Ã¼retilen Depot dosyalarÄ± `collected` klasÃ¶rÃ¼ne otomatik olarak eklendi/gÃ¼ncellendi.
            
            **Not:** Ä°ÅŸlem sÄ±rasÄ±nda **keys** dosyasÄ± bulunamayan `_pkgs.txt` dosyalarÄ± atlandÄ±, ancak bu bir hataya yol aÃ§madÄ±.
            
            TeÅŸekkÃ¼rler! ğŸ¤–
          delete-branch: false # PR kapatÄ±lsa bile branch'i silme (daha gÃ¼venli bir varsayÄ±lan)
